%% mnb_Simple_PSO_driver
% This is a simple example of how to use particle swarm optimization via
% mnb_PSOFit. It loads an inhibition curve (response x drug dose) and does
% a standard 3-parameter curve fit.
%
% Usage: mnb_Simple_PSO_driver()
%

%% Required Input Arguments (in order)
%
% None
%
%% Optional Input Arguments (passed via Param-Value pairs)
%
% None
%
%% Function Output Arguments
%
% None
%
%% Dependencies
%
% * mnb_PSOFit
%
% * mnb_PSOOptions
%

%% Version Information
% * Last changed date: $Date: 2015-03-04 10:49:38 -0500 (Wed, 04 Mar 2015) $
% * Last changed by: $Author: jkearns $
% * Last changed revision: $Revision: 1560 $
%
% Copyright 2012-2015 Merrimack Pharmaceuticals, Inc.

function [gp_best,gf_best] = ODE_driver_CollectedTimeCourse(ObjFuncData, params)
% Load experimental data -- a simple dose-response curve

% Configure the PSO options
% Load a struct variable with default PSO options
%when fitting to Full model
%params = [0.280000000000000;0.630000000000000;0.0220000000000000;0.0800000000000000;0.0630000000000000;3.40000000000000;0.331000000000000;8.70000000000000;0.940000000000000;0.340000000000000;0.468000000000000;0.0740000000000000;33.3333000000000;6.50000000000000;2.12000000000000e-14;0.140000000000000;7.32000000000000e+18;1.25000000000000e+18;3.05000000000000e+17;1.50000000000000e+18;773.666700000000;426.666700000000;0.421700000000000;8.87000000000000e+16;4.30000000000000e+16;6.07000000000000e+17;2.27000000000000e+18;260;9.17000000000000e+42;1.75000000000000e+38;30.0667000000000;1670;458.333300000000;41.5833000000000;6.03330000000000;968.333300000000;368.333300000000;5880000;64500;598000;39.3333000000000;53200;415;1670000000000.00;4.94330000000000;0.288300000000000;6450000;0.291700000000000;0.771700000000000;2.90000000000000;11.9700000000000;0.646700000000000;92.5000000000000;1.10670000000000;0.0200000000000000;0.100000000000000;1.80000000000000;10;0.900000000000000;1;9.30000000000000;10;3.86000000000000e-07;3.86000000000000e-07;0.000332000000000000;0.0280000000000000;1.00000000000000e-06;0.000500000000000000;0.000100000000000000;6.30000000000000e-05;1.00000000000000e-08;1.50000000000000e-07;0.000332000000000000;0.0100000000000000;0.000200000000000000;0.000300000000000000;2.50000000000000e-05;1.30000000000000e-05;5.00000000000000e-05;5.90000000000000e-07;6.90000000000000e-07;0.000550000000000000;0.000300000000000000;0.000180000000000000;6.00000000000000e-05;3.50000000000000e-05;3.60000000000000e-05;856;3.86000000000000e-07;0.0626000000000000;1;1;0.0500000000000000;1];
%When fitting to orig cancer model
%params = [0.0280000000000000;0.0410000000000000;0.280000000000000;0.630000000000000;0.0220000000000000;0.0800000000000000;0.0630000000000000;3.40000000000000;0.331000000000000;8.70000000000000;0.940000000000000;0.340000000000000;0.0870000000000000;0.468000000000000;0.0740000000000000;33.3333333300000;6.50000000000000;2.11790000000000e-14;0.140000000000000;0.0300000000000000;7.31666666666667e+18;1.24666666666667e+18;3.05000000000000e+17;1.50000000000000e+18;773.666666700000;426.666666700000;0.421666667000000;8.86666666666667e+16;4.30000000000000e+16;6.06667000000000e+17;2.26667000000000e+18;260;9.16667000000000e+42;1.75000000000000e+38;3.16166666700000;30.0666666700000;1666.66666700000;458.333333300000;41.5833333300000;6.03333333300000;968.333333300000;368.333333300000;5883333.33300000;64500;598333.333300000;39.3333333300000;53166.6666700000;415;1666670000000.00;4.94333333300000;0.288333333000000;6450000;0.291666667000000;0.771666667000000;2.90000000000000;11.9700000000000;0.646666667000000;92.5000000000000;1.10666666700000;0.0200000000000000;0.100000000000000;1.80000000000000;10;0.900000000000000;1;9.30000000000000;10;0.000386170000000000;0.000386170000000000;0.332110000000000;1; 0.5; 0.542125648135445;3.76168895009916;0.454448540472248;0.706990028881560;0.0156565460978362;0.478582126811771;4.39031164654454;0.168038706461350;4.21968660787895;0.0560506065370617;0.397377606983681;0.583587181302951;0.716708019845057;0.000154147902632731;0.136501997249423;0.132939511019276;0.00456400046649098;0.000733943694403398;0.00134582377890930;0.00483413989498314;0.0379963772949342;0.00192408120909374;4.23518730127469;2.45107434802339e-06;0.000771217660846397;2.09292143332501;0.288669565535384;0.00779378981985000;0.224895886981259;12.6827767477872;6.03285037234089e-05;6.77882129684873e-05;0.000309121127035145;1.74318833008063e-06;1.45680249381982e-05;2.94658145921870;3.12055381157148e-05;0.797796208874077;2.65472943228149e-07;2.85338922615892e-05;0.0240841285605586;1.05706088817784e-05;3.31601148362778;0.0170013921210288;0.00150069872532053;2.47590966892564;0.0300000000000000;2.15537701634457e-07;4.94999978446232;3.43977996188819;1.51575084594245e-06;0.0400301566013678;1.72526016292169;0.0300000000000000];
%params = [0.0280000000000000;0.0410000000000000;0.280000000000000;0.630000000000000;0.0220000000000000;0.0800000000000000;0.0630000000000000;3.40000000000000;0.331000000000000;8.70000000000000;0.940000000000000;0.340000000000000;0.0870000000000000;0.468000000000000;0.0740000000000000;33.3333333300000;6.50000000000000;2.11790000000000e-14;0.140000000000000;0.0300000000000000;7.31666666666667e+18;1.24666666666667e+18;3.05000000000000e+17;1.50000000000000e+18;773.666666700000;426.666666700000;0.421666667000000;8.86666666666667e+16;4.30000000000000e+16;6.06667000000000e+17;2.26667000000000e+18;260;9.16667000000000e+42;1.75000000000000e+38;3.16166666700000;30.0666666700000;1666.66666700000;458.333333300000;41.5833333300000;6.03333333300000;968.333333300000;368.333333300000;5883333.33300000;64500;598333.333300000;39.3333333300000;53166.6666700000;415;1666670000000.00;4.94333333300000;0.288333333000000;6450000;0.291666667000000;0.771666667000000;2.90000000000000;11.9700000000000;0.646666667000000;92.5000000000000;1.10666666700000;0.0200000000000000;0.100000000000000;1.80000000000000;10;0.900000000000000;1;9.30000000000000;10;0.000386170000000000;0.000386170000000000;0.332110000000000;1; 0.5; 0.542125648135445;3.76168895009916;0.454448540472248;0.706990028881560;0.0156565460978362;0.478582126811771;4.39031164654454;0.168038706461350;4.21968660787895;0.0560506065370617;0.397377606983681;0.583587181302951;0.716708019845057;0.000154147902632731;0.136501997249423;0.132939511019276;0.00456400046649098;0.000733943694403398;0.00134582377890930;0.00483413989498314;0.0379963772949342;0.00192408120909374;4.23518730127469;2.45107434802339e-06;0.000771217660846397;2.09292143332501;0.288669565535384;0.00779378981985000;0.224895886981259;12.6827767477872;6.03285037234089e-05;6.77882129684873e-05;0.000309121127035145;1.74318833008063e-06;1.45680249381982e-05;2.94658145921870;3.12055381157148e-05;0.797796208874077;2.65472943228149e-07;2.85338922615892e-05;0.0240841285605586;1.05706088817784e-05;3.31601148362778;0.0170013921210288;0.00150069872532053;2.47590966892564;0.0300000000000000;2.15537701634457e-07;4.94999978446232;3.43977996188819;1.51575084594245e-06;0.0400301566013678;1.72526016292169;0.0300000000000000];

%Fitting Params


LB = params;
UB = params;
%tofit = [ 1 2 10 14 15 16 17 19 21 23 26 27 29 30 34 35 36 37 38 39 41 42 48 50 53 54 55 56 57 64 66 69 71 72 74 76 77 78];
%tofit = [ 2 10 14 15 16 17 20 23 26 27 29 30 34 36 37 38 39 42 48 50 54 55 56 57 64 66 69 71 72 74 76 77 78];

% %
tofit = [ 1 2 12 13 14 17 20 23 38 39 41 47 52 53 56 58 64 67 77 79 80 81];
LB(tofit) = 0.9.*params(tofit);
UB(tofit) = 1.1*params(tofit);

% LB = 0.01 .*params;
% UB = 100 .*params;

% Define the variable that PSOFit will pass to the objective function.
% As PSOFit will only pass one variable, it is recommended that
% multiple variables be stored in a struct variable.
PSOopts.ObjFuncData = ObjFuncData;
% Configure PSO to search log-space for all the parameters
%  - As a general rule, it is recommended that values be log
%  transformmed if the bounds span >= 2 orders of magnitude.
%  - PSOFit uses the log transformed values internally, but passes
%  the linearized values to the objective function.
PSOopts.LogTransform = true(length(LB),1);

% Swarm options
PSOopts.NumSwp  = 31;  % Number of swarm particles = number of the CPUs
PSOopts.lmin    = 3;

% PSO exit criteria
PSOopts.MaxIter     = 350;
PSOopts.FitCount    =60;  %80 before % Exit if PSO count reaches this value

% Status display and file exports
PSOopts.Verbose         = true; % disable status display
PSOopts.FN_IntState     = ''; % 'EarlierIntState.mat';

PSOopts.UseParallel  =  true;
% This is an example of how you can load the results from a
% previous run of mnb_PSOFit and start a new fit from that point.
% Doing this is useful if you stopped the previous run prematurely.
% PSOopts.FN_IntState_restart     = 'EarlierIntState.mat';
% Define the objective function
    
ObjFuncName = 'ODE_ObjFunc_CollectedTimeCourse';
% PSOopts.ObjFuncDir  = 'PSO_Examples';
% Run mnb_PSOFit
[gp_best,gf_best] = mnb_PSOFit(ObjFuncName,LB,UB,PSOopts)
end

  